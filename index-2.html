<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¢ç¢¼æƒæå…¬æ–‡ç·¨è™Ÿè¼¸å…¥</title>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #007BFF;
      outline: none;
    }
    .scanner-section {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .scan-btn {
      background-color: #007BFF;
      color: white;
    }
    .scan-btn:hover {
      background-color: #0056b3;
    }
    .submit-btn {
      background-color: #28a745;
      color: white;
    }
    .submit-btn:hover {
      background-color: #218838;
    }
    .stop-btn {
      background-color: #dc3545;
      color: white;
    }
    .stop-btn:hover {
      background-color: #c82333;
    }
    #video {
      width: 100%;
      max-width: 300px;
      height: 200px;
      border: 2px solid #007BFF;
      border-radius: 5px;
      display: none;
    }
    .info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #0066cc;
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 5px;
      display: none;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“„ å…¬æ–‡æ¢ç¢¼æƒæ</h1>
    
    <div class="info">
      ğŸ“± é»æ“Šã€Œé–‹å§‹æƒæã€å•Ÿç”¨ç›¸æ©Ÿï¼Œå°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®
    </div>

    <div class="input-group">
      <label for="document-id">å…¬æ–‡ç·¨è™Ÿï¼š</label>
      <input type="text" id="document-id" placeholder="å¯æ‰‹å‹•è¼¸å…¥æˆ–æƒææ¢ç¢¼">
    </div>
    
    <div class="scanner-section">
      <button id="start-btn" class="scan-btn">ğŸ“· é–‹å§‹æƒæ</button>
      <button id="stop-btn" class="stop-btn" style="display:none;">â¹ï¸ åœæ­¢æƒæ</button>
      <video id="video"></video>
    </div>
    
    <button id="submit-btn" class="submit-btn">âœ… æäº¤å…¬æ–‡ç·¨è™Ÿ</button>
    
    <div id="result" class="result">
      <strong>æƒææˆåŠŸï¼</strong><br>
      å…¬æ–‡ç·¨è™Ÿï¼š<span id="result-text"></span>
    </div>
  </div>

  <script>
    let codeReader = null;
    let selectedDeviceId = null; // ç”¨æ–¼å­˜å„²é¸æ“‡çš„ç›¸æ©ŸID
    
    const documentIdInput = document.getElementById('document-id');
    const video = document.getElementById('video');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('result');
    const resultText = document.getElementById('result-text');

    // åˆå§‹åŒ–æ¢ç¢¼è®€å–å™¨
    function initializeCodeReader() {
      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
        console.log('ZXing code reader initialized');
        
        // ç²å–æ‰€æœ‰è¦–è¨Šè¨­å‚™
        codeReader.listVideoInputDevices()
          .then((videoInputDevices) => {
            if (videoInputDevices.length > 0) {
              // å„ªå…ˆé¸æ“‡å¾Œç½®é¡é ­
              const rearCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('å¾Œ'));
              selectedDeviceId = rearCamera ? rearCamera.deviceId : videoInputDevices[0].deviceId;
            }
          })
          .catch(err => console.error(err));
      }
    }

    // é–‹å§‹æƒæ
    function startScanning() {
      initializeCodeReader();
      
      video.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      resultDiv.style.display = 'none';
      documentIdInput.value = '';
      
      // ä½¿ç”¨é€£çºŒæƒææ¨¡å¼
      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          // æƒææˆåŠŸ
          console.log('æƒæçµæœ:', result.text);
          documentIdInput.value = result.text;
          resultText.textContent = result.text;
          resultDiv.style.display = 'block';
          
          // æ’­æ”¾æç¤ºéŸ³
          const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(3).join('1234567890'));
          audio.play();

          // è‡ªå‹•åœæ­¢
          stopScanning();
          
          setTimeout(() => {
            resultDiv.style.display = 'none';
          }, 3000);
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error('æƒæéŒ¯èª¤:', err);
          showError('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿæˆ–æƒææ¢ç¢¼ï¼Œè«‹æª¢æŸ¥ï¼š\n1. ç€è¦½å™¨æ¬Šé™\n2. ç›¸æ©Ÿæ˜¯å¦è¢«å…¶ä»–æ‡‰ç”¨å ç”¨\n3. ç¶²ç«™æ˜¯å¦ä½¿ç”¨ HTTPS');
          stopScanning();
        }
      });
    }

    // åœæ­¢æƒæ
    function stopScanning() {
      if (codeReader) {
        codeReader.reset();
      }
      video.style.display = 'none';
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
    }

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
      const tempDiv = document.createElement('div');
      tempDiv.className = 'result error';
      tempDiv.innerHTML = `<strong>éŒ¯èª¤ï¼š</strong><br>${message.replace(/\n/g, '<br>')}`;
      
      const container = document.querySelector('.container');
      container.appendChild(tempDiv);
      
      setTimeout(() => {
        if (container.contains(tempDiv)) {
          container.removeChild(tempDiv);
        }
      }, 5000);
    }

    // æäº¤è¡¨å–®
    function submitForm() {
      const docId = documentIdInput.value.trim();
      if (!docId) {
        alert('è«‹è¼¸å…¥æˆ–æƒæå…¬æ–‡ç·¨è™Ÿ');
        return;
      }
      console.log('æäº¤å…¬æ–‡ç·¨è™Ÿ:', docId);
      alert(`å…¬æ–‡ç·¨è™Ÿå·²æäº¤ï¼š${docId}`);
      documentIdInput.value = '';
    }

    // --- äº‹ä»¶ç¶å®š ---
    startBtn.addEventListener('click', startScanning);
    stopBtn.addEventListener('click', stopScanning);
    submitBtn.addEventListener('click', submitForm);

    documentIdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && documentIdInput.value.trim()) {
        submitForm();
      }
    });

    window.addEventListener('beforeunload', stopScanning);
    
    // é é¢è¼‰å…¥æ™‚å°±åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializeCodeReader);
  </script>
</body>
</html>
