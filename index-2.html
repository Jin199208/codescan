<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>條碼掃描公文編號輸入</title>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #007BFF;
      outline: none;
    }
    .scanner-section {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .scan-btn {
      background-color: #007BFF;
      color: white;
    }
    .scan-btn:hover {
      background-color: #0056b3;
    }
    .submit-btn {
      background-color: #28a745;
      color: white;
    }
    .submit-btn:hover {
      background-color: #218838;
    }
    .stop-btn {
      background-color: #dc3545;
      color: white;
    }
    .stop-btn:hover {
      background-color: #c82333;
    }
    #video {
      width: 100%;
      max-width: 300px;
      height: 200px;
      border: 2px solid #007BFF;
      border-radius: 5px;
      display: none;
    }
    .info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #0066cc;
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 5px;
      display: none;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📄 公文條碼掃描</h1>
    
    <div class="info">
      📱 點擊「開始掃描」啟用相機，將條碼對準畫面中央
    </div>

    <div class="input-group">
      <label for="document-id">公文編號：</label>
      <input type="text" id="document-id" placeholder="可手動輸入或掃描條碼">
    </div>
    
    <div class="scanner-section">
      <button id="start-btn" class="scan-btn">📷 開始掃描</button>
      <button id="stop-btn" class="stop-btn" style="display:none;">⏹️ 停止掃描</button>
      <video id="video"></video>
    </div>
    
    <button id="submit-btn" class="submit-btn">✅ 提交公文編號</button>
    
    <div id="result" class="result">
      <strong>掃描成功！</strong><br>
      公文編號：<span id="result-text"></span>
    </div>
  </div>

  <script>
    let codeReader = null;
    let selectedDeviceId = null; // 用於存儲選擇的相機ID
    
    const documentIdInput = document.getElementById('document-id');
    const video = document.getElementById('video');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('result');
    const resultText = document.getElementById('result-text');

    // 初始化條碼讀取器
    function initializeCodeReader() {
      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
        console.log('ZXing code reader initialized');
        
        // 獲取所有視訊設備
        codeReader.listVideoInputDevices()
          .then((videoInputDevices) => {
            if (videoInputDevices.length > 0) {
              // 優先選擇後置鏡頭
              const rearCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('後'));
              selectedDeviceId = rearCamera ? rearCamera.deviceId : videoInputDevices[0].deviceId;
            }
          })
          .catch(err => console.error(err));
      }
    }

    // 開始掃描
    function startScanning() {
      initializeCodeReader();
      
      video.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      resultDiv.style.display = 'none';
      documentIdInput.value = '';
      
      // 使用連續掃描模式
      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          // 掃描成功
          console.log('掃描結果:', result.text);
          documentIdInput.value = result.text;
          resultText.textContent = result.text;
          resultDiv.style.display = 'block';
          
          // 播放提示音
          const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(3).join('1234567890'));
          audio.play();

          // 自動停止
          stopScanning();
          
          setTimeout(() => {
            resultDiv.style.display = 'none';
          }, 3000);
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error('掃描錯誤:', err);
          showError('無法啟動相機或掃描條碼，請檢查：\n1. 瀏覽器權限\n2. 相機是否被其他應用占用\n3. 網站是否使用 HTTPS');
          stopScanning();
        }
      });
    }

    // 停止掃描
    function stopScanning() {
      if (codeReader) {
        codeReader.reset();
      }
      video.style.display = 'none';
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
    }

    // 顯示錯誤訊息
    function showError(message) {
      const tempDiv = document.createElement('div');
      tempDiv.className = 'result error';
      tempDiv.innerHTML = `<strong>錯誤：</strong><br>${message.replace(/\n/g, '<br>')}`;
      
      const container = document.querySelector('.container');
      container.appendChild(tempDiv);
      
      setTimeout(() => {
        if (container.contains(tempDiv)) {
          container.removeChild(tempDiv);
        }
      }, 5000);
    }

    // 提交表單
    function submitForm() {
      const docId = documentIdInput.value.trim();
      if (!docId) {
        alert('請輸入或掃描公文編號');
        return;
      }
      console.log('提交公文編號:', docId);
      alert(`公文編號已提交：${docId}`);
      documentIdInput.value = '';
    }

    // --- 事件綁定 ---
    startBtn.addEventListener('click', startScanning);
    stopBtn.addEventListener('click', stopScanning);
    submitBtn.addEventListener('click', submitForm);

    documentIdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && documentIdInput.value.trim()) {
        submitForm();
      }
    });

    window.addEventListener('beforeunload', stopScanning);
    
    // 頁面載入時就初始化
    document.addEventListener('DOMContentLoaded', initializeCodeReader);
  </script>
</body>
</html>
