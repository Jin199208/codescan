<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¢ç¢¼æƒæå…¬æ–‡ç·¨è™Ÿè¼¸å…¥</title>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #007BFF;
      outline: none;
    }
    .scanner-section {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .scan-btn {
      background-color: #007BFF;
      color: white;
    }
    .scan-btn:hover {
      background-color: #0056b3;
    }
    .submit-btn {
      background-color: #28a745;
      color: white;
    }
    .submit-btn:hover {
      background-color: #218838;
    }
    .stop-btn {
      background-color: #dc3545;
      color: white;
    }
    .stop-btn:hover {
      background-color: #c82333;
    }
    #video {
      width: 100%;
      max-width: 300px;
      height: 200px;
      border: 2px solid #007BFF;
      border-radius: 5px;
      display: none;
    }
    .info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #0066cc;
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 5px;
      display: none;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“„ å…¬æ–‡æ¢ç¢¼æƒæ</h1>
    
    <div class="info">
      ğŸ“± é»æ“Šã€Œé–‹å§‹æƒæã€å•Ÿç”¨ç›¸æ©Ÿï¼Œå°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®
    </div>

    <div class="input-group">
      <label for="document-id">å…¬æ–‡ç·¨è™Ÿï¼š</label>
      <input type="text" id="document-id" placeholder="æ¢ç¢¼æƒæå¾Œè‡ªå‹•å¡«å…¥" readonly>
    </div>
    
    <div class="scanner-section">
      <button id="start-btn" class="scan-btn" onclick="startScanning()">ğŸ“· é–‹å§‹æƒæ</button>
      <button id="stop-btn" class="stop-btn" onclick="stopScanning()" style="display:none;">â¹ï¸ åœæ­¢æƒæ</button>
      <video id="video"></video>
    </div>
    
    <button class="submit-btn" onclick="submitForm()">âœ… æäº¤å…¬æ–‡ç·¨è™Ÿ</button>
    
    <div id="result" class="result">
      <strong>æƒææˆåŠŸï¼</strong><br>
      å…¬æ–‡ç·¨è™Ÿï¼š<span id="result-text"></span>
    </div>
  </div>

  <script>
    let codeReader = null;
    let scanning = false;
    
    const documentIdInput = document.getElementById('document-id');
    const video = document.getElementById('video');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const resultDiv = document.getElementById('result');
    const resultText = document.getElementById('result-text');

    // åˆå§‹åŒ–æ¢ç¢¼è®€å–å™¨
    function initializeCodeReader() {
      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }
    }

    // é–‹å§‹æƒæ
    async function startScanning() {
      try {
        initializeCodeReader();
        
        // é¡¯ç¤ºè¦–é »å…ƒç´ 
        video.style.display = 'block';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        // æ¸…é™¤ä¹‹å‰çš„çµæœ
        resultDiv.style.display = 'none';
        documentIdInput.value = '';
        
        scanning = true;
        
        // é–‹å§‹æƒæï¼ˆä½¿ç”¨å¾Œç½®ç›¸æ©Ÿï¼‰
        const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'video');
        
        if (result && scanning) {
          // æƒææˆåŠŸ
          const scannedText = result.text;
          documentIdInput.value = scannedText;
          resultText.textContent = scannedText;
          resultDiv.style.display = 'block';
          
          // è‡ªå‹•åœæ­¢æƒæ
          stopScanning();
          
          // 3ç§’å¾Œéš±è—çµæœ
          setTimeout(() => {
            resultDiv.style.display = 'none';
          }, 3000);
        }
        
      } catch (error) {
        console.error('æƒæéŒ¯èª¤:', error);
        showError('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿæˆ–æƒææ¢ç¢¼ï¼Œè«‹æª¢æŸ¥ï¼š\n1. ç€è¦½å™¨æ¬Šé™\n2. ç›¸æ©Ÿæ˜¯å¦è¢«å…¶ä»–æ‡‰ç”¨å ç”¨\n3. ç¶²ç«™æ˜¯å¦ä½¿ç”¨ HTTPS');
        stopScanning();
      }
    }

    // åœæ­¢æƒæ
    function stopScanning() {
      scanning = false;
      
      if (codeReader) {
        codeReader.reset();
      }
      
      video.style.display = 'none';
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
    }

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
      const tempDiv = document.createElement('div');
      tempDiv.className = 'result error';
      tempDiv.innerHTML = `<strong>éŒ¯èª¤ï¼š</strong><br>${message.replace(/\n/g, '<br>')}`;
      
      const container = document.querySelector('.container');
      container.appendChild(tempDiv);
      
      setTimeout(() => {
        container.removeChild(tempDiv);
      }, 5000);
    }

    // æäº¤è¡¨å–®
    function submitForm() {
      const docId = documentIdInput.value.trim();
      
      if (!docId) {
        alert('è«‹å…ˆæƒææ¢ç¢¼å–å¾—å…¬æ–‡ç·¨è™Ÿ');
        return;
      }
      
      // é€™è£¡æ•´åˆåˆ°ä½ çš„åŸå§‹ç³»çµ±
      console.log('æäº¤å…¬æ–‡ç·¨è™Ÿ:', docId);
      alert(`å…¬æ–‡ç·¨è™Ÿå·²æäº¤ï¼š${docId}`);
      
      // æ¸…é™¤è¼¸å…¥
      documentIdInput.value = '';
    }

    // é é¢å¸è¼‰æ™‚åœæ­¢æƒæ
    window.addEventListener('beforeunload', () => {
      stopScanning();
    });

    // æ”¯æ´ Enter éµæäº¤
    documentIdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && documentIdInput.value.trim()) {
        submitForm();
      }
    });
  </script>
</body>
</html>
